<!-- 引用控制层插件样式 -->
<link rel="stylesheet" href="lib/jq-module/zyupload/control/css/zyUpload.css" type="text/css">

<script src="lib/mods/base64.js"></script>

<div class="layuimini-container layuimini-page-anim">
    <div class="layuimini-main">
        <form class="layui-form layui-form-pane" id="addHousing" action="">
            <!--房源信息-->
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend>房源信息</legend>
            </fieldset>
            <!--标题-->
            <div class="layui-form-item">
                <label class="layui-form-label">房源标题</label>
                <div class="layui-input-block">
                    <input type="text" name="title" lay-verify="title" autocomplete="off" placeholder="请输入标题"
                           class="layui-input">
                </div>
            </div>
            <!--地址-->
            <div class="layui-form-item" id="area-picker">
                <div class="layui-form-label">地址</div>
                <div class="layui-input-inline" style="width: 200px;">
                    <select name="province" lay-search="" class="province-selector" data-value="选择省" lay-verify="required" lay-filter="province-1">
                        <option value="">请选择省</option>
                    </select>
                </div>
                <div class="layui-input-inline" style="width: 200px;">
                    <select name="city" lay-search="" class="city-selector" data-value="选择市" lay-verify="required" lay-filter="city-1">
                        <option value="">请选择市</option>
                    </select>
                </div>
                <div class="layui-input-inline" style="width: 200px;">
                    <select name="county" lay-search="" class="county-selector" data-value="选择区" lay-verify="required" lay-filter="county-1">
                        <option value="">请选择区</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">详细地址</label>
                <div class="layui-input-block">
                    <input class="layui-input" id="addrDetail"  autocomplete="on" lay-verify="addrDetail"
                           placeholder="街道+小区名">
                </div>
            </div>
            <!--楼栋-->
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">楼栋</label>
                    <div class="layui-input-inline">
                        <input type="text" name="buildingNum"  lay-verify="required|number" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid">栋</div>
                    <div class="layui-input-inline">
                        <input type="text" name="buildingUnit"  lay-verify="required|number" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid">单元</div>
                    <div class="layui-input-inline">
                        <input type="text" name="buildingFloorNum"  lay-verify="required|number" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid">门牌号</div>
                </div>
            </div>
            <!--楼层-->
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">所处楼层</label>
                    <div class="layui-input-inline">
                        <input type="text" name="floor_1"  lay-verify="required|number" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid ">层</div>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">总楼层</label>
                <div class="layui-inline">
                    <div class="layui-input-inline">
                        <input type="text" name="floor_2"  lay-verify="required|number" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid">层</div>
                </div>
            </div>
            <!--户型-->
            <div class="layui-form-item layui-inline">
                <label class="layui-form-label">户型</label>
                <div class="layui-input-inline">
                    <input type="text" name="houseType_1"  lay-verify="required|number" autocomplete="off" class="layui-input">
                </div>
                <div class="layui-form-mid">室</div>
                <div class="layui-input-inline">
                    <input type="text" name="houseType_2"  lay-verify="required|number" autocomplete="off" class="layui-input">
                </div>
                <div class="layui-form-mid">厅&nbsp;&nbsp;&nbsp;&nbsp;</div>
                <div class="layui-input-inline">
                    <input type="text" name="houseType_3"  lay-verify="required|number" autocomplete="off" class="layui-input">
                </div>
                <div class="layui-form-mid">卫</div>
                <div class="layui-input-inline">
                    <input type="text" name="houseType_4"  lay-verify="required|number" autocomplete="off" class="layui-input">
                </div>
                <div class="layui-form-mid">厨</div>
                <div class="layui-input-inline">
                    <input type="text" name="houseType_5"  lay-verify="required|number" autocomplete="off" class="layui-input">
                </div>
                <div class="layui-form-mid">阳台</div>
            </div>
            <!--面积-->
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">建筑面积</label>
                    <div class="layui-input-inline">
                        <input type="text" name="coveredArea" lay-verify="required|number" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid">平方米</div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">使用面积</label>
                    <div class="layui-input-inline">
                        <input type="text" name="useArea" lay-verify="required|number" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid">平方米</div>
                </div>
            </div>
            <!--朝向-->
            <div class="layui-form-item layui-inline">
                <label class="layui-form-label">朝向</label>
                <div class="layui-input-inline">
                    <select name="orientation" lay-verify="required">
                        <option value="">请选择朝向</option>
                        <option value="1">南</option>
                        <option value="2">东</option>
                        <option value="3">北</option>
                        <option value="4">西</option>
                    </select>
                </div>
            </div>
            <!--装修-->
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">装修</label>
                    <div class="layui-input-inline">
                        <select name="decoration" lay-verify="required">
                            <option value="">请选择装修类型</option>
                            <option value="1">精装</option>
                            <option value="2">简装</option>
                            <option value="3">毛坯</option>
                        </select>
                    </div>
                </div>
            </div>
            <!--配套设施-->
            <div class="layui-form-item" pane="">
                <label class="layui-form-label">配套设施</label>
                <div class="layui-input-block">
                    <input type="checkbox" name="facilities_1" lay-skin="primary" title="水" checked="">
                    <input type="checkbox" name="facilities_2" lay-skin="primary" title="电" checked>
                    <input type="checkbox" name="facilities_3" lay-skin="primary" title="煤气/天然气" checked>
                    <input type="checkbox" name="facilities_4" lay-skin="primary" title="暖气/地暖">
                    <input type="checkbox" name="facilities_5" lay-skin="primary" title="有线电视">
                    <input type="checkbox" name="facilities_6" lay-skin="primary" title="宽带">
                    <input type="checkbox" name="facilities_7" lay-skin="primary" title="电梯">
                    <input type="checkbox" name="facilities_8" lay-skin="primary" title="车位/车库">
                    <input type="checkbox" name="facilities_9" lay-skin="primary" title="地下室/储藏室">
                </div>
            </div>

            <!--图片信息-->
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px;">
                <legend>图片信息</legend>
            </fieldset>
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">最多上传四张图片</label>
                <div name="pic" class="layui-input-block">
                    <div id="demo" class="demo layui-textarea" pic=""></div>
                </div>
            </div>
            <!--房源描述-->
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">房源描述</label>
                <div class="layui-input-block">
                    <textarea name="desc" placeholder="请勿填写联系方式或与房源信息以及图片、链接或品牌、优秀、顶级、全网首发、零距离、回报率等词汇。" class="layui-textarea"></textarea>
                </div>
            </div>

            <!--租赁信息-->
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px;">
                <legend>租赁信息</legend>
            </fieldset>
            <div class="layui-form-item">
                <!--联系人-->
                <div class="layui-form-item layui-inline">
                    <label class="layui-form-label">联系人</label>
                    <div class="layui-input-block">
                        <input type="text" autocomplete name="contact" lay-verify="ZH" placeholder="请输入联系人" class="layui-input">
                    </div>
                </div>
                <!--联系方式-->
                <div class="layui-form-item layui-inline">
                    <div class="layui-inline">
                        <label class="layui-form-label">联系方式</label>
                        <div class="layui-input-inline">
                            <input type="tel" autocomplete="on" placeholder="请输入联系方式" name="mobile" lay-verify="required|phone" class="layui-input">
                        </div>
                    </div>
                </div>
            </div>
            <!--租赁方式-->
            <div class="layui-form-item layui-inline">
                <label class="layui-form-label">租赁方式</label>
                <div class="layui-input-inline">
                    <select name="rent_method" lay-verify="required">
                        <option value="">请选择租赁方式</option>
                        <option value="1">整租</option>
                        <option value="2">合租</option>
                    </select>
                </div>
            </div>
            <!--支付方式-->
            <div class="layui-form-item layui-inline">
                <label class="layui-form-label">支付方式</label>
                <div class="layui-input-inline">
                    <select name="payment_method" lay-verify="required">
                        <option value="">请选择支付方式</option>
                        <option value="1">付一押一</option>
                        <option value="2">付三押一</option>
                        <option value="3">付六押一</option>
                        <option value="4">年付押一</option>
                        <option value="5">其它</option>
                    </select>
                </div>
            </div>
            <!--看房时间-->
            <div class="layui-form-item layui-inline">
                <label class="layui-form-label">看房时间</label>
                <div class="layui-input-inline">
                    <select name="time" lay-verify="required">
                        <option value="">请选择看房时间</option>
                        <option value="1">上午</option>
                        <option value="2">中午</option>
                        <option value="3">下午</option>
                        <option value="4">晚上</option>
                        <option value="5">全天</option>
                    </select>
                </div>
            </div>
            <!--租金-->
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">租金</label>
                    <div class="layui-input-inline">
                        <input type="text" name="rent" lay-verify="required|number" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid">元/月</div>
                </div>
            </div>
            <!--物业费-->
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">物业费</label>
                    <div class="layui-input-inline">
                        <input type="text" name="propertyCost" lay-verify="required|number" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid">元/平</div>
                </div>
            </div>

            <!--提交-->
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit="" lay-filter="demo1">立即提交</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!--表单基本组件-->
<script>
    layui.config({
        base: 'lib/mods/'
    });
    layui.use(['jquery','form','layarea','layer'], function () {
        //加载组件
        var $ = layui.jquery;

        $.fn.zyUpload = function(options,param){

            var otherArgs = Array.prototype.slice.call(arguments, 1);
            if (typeof options == 'string') {
                var fn = this[0][options];
                if($.isFunction(fn)){
                    return fn.apply(this, otherArgs);
                }else{
                    throw ("zyUpload - No such method: " + options);
                }
            }

            return this.each(function(){
                var para = {};    // 保留参数
                var self = this;  // 保存组件对象

                var defaults = {
                    width            : "700px",  					// 宽度
                    height           : "400px",  					// 宽度
                    itemWidth        : "140px",                     // 文件项的宽度
                    itemHeight       : "120px",                     // 文件项的高度
                    url              : "/upload/UploadAction",  	// 上传文件的路径
                    multiple         : true,  						// 是否可以多个文件上传
                    dragDrop         : true,  						// 是否可以拖动上传文件
                    del              : true,  						// 是否可以删除文件
                    finishDel        : false,  						// 是否在上传文件完成后删除预览
                    /* 提供给外部的接口方法 */
                    onSelect         : function(selectFiles, files){},// 选择文件的回调方法  selectFile:当前选中的文件  allFiles:还没上传的全部文件
                    onDelete		 : function(file, files){},     // 删除一个文件的回调方法 file:当前删除的文件  files:删除之后的文件
                    onSuccess		 : function(file){},            // 文件上传成功的回调方法
                    onFailure		 : function(file){},            // 文件上传失败的回调方法
                    onComplete		 : function(responseInfo){},    // 上传完成的回调方法
                };

                para = $.extend(defaults,options);

                this.init = function(){
                    this.createHtml();  // 创建组件html
                    this.createCorePlug();  // 调用核心js
                };

                /**
                 * 功能：创建上传所使用的html
                 * 参数: 无
                 * 返回: 无
                 */
                this.createHtml = function(){
                    var multiple = "";  // 设置多选的参数
                    para.multiple ? multiple = "multiple" : multiple = "";
                    var html= '';

                    if(para.dragDrop){
                        // 创建带有拖动的html
                        html += '<form id="uploadForm" action="'+para.url+'" method="post" enctype="multipart/form-data">';
                        html += '	<div class="upload_box">';
                        html += '		<div class="upload_main">';
                        html += '			<div class="upload_choose">';
                        html += '				<div class="convent_choice">';
                        html += '					<div class="andArea">';
                        html += '						<div class="filePicker">点击选择文件</div>';
                        html += '						<input id="fileImage" type="file" size="30" name="fileselect[]" '+multiple+'>';
                        html += '					</div>';
                        html += '				</div>';
                        html += '				<span id="fileDragArea" class="upload_drag_area">或者将文件拖到此处</span>';
                        html += '			</div>';
                        html += '			<div class="status_bar">';
                        html += '				<div id="status_info" class="info">选中0张文件，共0B。</div>';
                        html += '				<div class="btns">';
                        html += '					<div class="upload_btn">开始上传</div>';
                        html += '				</div>';
                        html += '			</div>';
                        html += '			<div id="preview" class="upload_preview"></div>';
                        html += '		</div>';
                        html += '		<div class="upload_submit">';
                        html += '			<button type="button" id="fileSubmit" class="upload_submit_btn">确认上传文件</button>';
                        html += '		</div>';
                        html += '		<div id="uploadInf" class="upload_inf"></div>';
                        html += '	</div>';
                        html += '</form>';
                    }else{
                        var imgWidth = parseInt(para.itemWidth.replace("px", ""))-15;

                        // 创建不带有拖动的html
                        html += '<form id="uploadForm" action="'+para.url+'" method="post" enctype="multipart/form-data">';
                        html += '	<div class="upload_box">';
                        html += '		<div class="upload_main single_main">';
                        html += '			<div class="status_bar">';
                        html += '				<div id="status_info" class="info">选中0张文件，共0B。</div>';
                        html += '				<div class="btns">';
                        html += '					<input id="fileImage" type="file" size="30" name="fileselect[]" '+multiple+'>';
                        html += '					<div class="webuploader_pick">选择文件</div>';
                        html += '					<div class="upload_btn">开始上传</div>';
                        html += '				</div>';
                        html += '			</div>';
                        html += '			<div id="preview" class="upload_preview">';
                        html += '				<div class="add_upload">';
                        html += '					<a style="height:'+para.itemHeight+';width:'+para.itemWidth+';" title="点击添加文件" id="rapidAddImg" class="add_imgBox" href="javascript:void(0)">';
                        html += '						<div class="uploadImg" style="width:'+imgWidth+'px">';
                        html += '							<img class="upload_image" src="control/images/add_img.png" style="width:expression(this.width > '+imgWidth+' ? '+imgWidth+'px : this.width)" />';
                        html += '						</div>';
                        html += '					</a>';
                        html += '				</div>';
                        html += '			</div>';
                        html += '		</div>';
                        html += '		<div class="upload_submit">';
                        html += '			<button type="button" id="fileSubmit" class="upload_submit_btn">确认上传文件</button>';
                        html += '		</div>';
                        html += '		<div id="uploadInf" class="upload_inf"></div>';
                        html += '	</div>';
                        html += '</form>';
                    }

                    $(self).append(html).css({"width":para.width,"height":para.height});

                    // 初始化html之后绑定按钮的点击事件
                    this.addEvent();
                };

                /**
                 * 功能：显示统计信息和绑定继续上传和上传按钮的点击事件
                 * 参数: 无
                 * 返回: 无
                 */
                this.funSetStatusInfo = function(files){
                    var size = 0;
                    var num = files.length;
                    $.each(files, function(k,v){
                        // 计算得到文件总大小
                        size += v.size;
                    });

                    // 转化为kb和MB格式。文件的名字、大小、类型都是可以现实出来。
                    if (size > 1024 * 1024) {
                        size = (Math.round(size * 100 / (1024 * 1024)) / 100).toString() + 'MB';
                    } else {
                        size = (Math.round(size * 100 / 1024) / 100).toString() + 'KB';
                    }

                    // 设置内容
                    $("#status_info").html("选中"+num+"张文件，共"+size+"。");
                };

                /**
                 * 功能：过滤上传的文件格式等
                 * 参数: files 本次选择的文件
                 * 返回: 通过的文件
                 */
                this.funFilterEligibleFile = function(files){
                    var arrFiles = [];  // 替换的文件数组

                    for (var i = 0, file; file = files[i]; i++) {
                        if (file.size >= 51200000) {
                            alert('您这个"'+ file.name +'"文件大小过大');
                        } else if(!file.type.startsWith("image")){
                            alert('请选择图片')
                        }else {
                            // 在这里需要判断当前所有文件中

                            arrFiles.push(file);
                        }
                    }
                    return arrFiles;
                };

                /**
                 * 功能： 处理参数和格式上的预览html
                 * 参数: files 本次选择的文件
                 * 返回: 预览的html
                 */
                this.funDisposePreviewHtml = function(file, e){
                    var html = "";
                    var imgWidth = parseInt(para.itemWidth.replace("px", ""))-15;

                    // 处理配置参数删除按钮
                    var delHtml = "";
                    if(para.del){  // 显示删除按钮
                        delHtml = '<span class="file_del" data-index="'+file.index+'" title="删除"></span>';
                    }

                    // 处理不同类型文件代表的图标
                    var fileImgSrc = "control/images/fileType/";
                    if(file.type.indexOf("rar") > 0){
                        fileImgSrc = fileImgSrc + "rar.png";
                    }else if(file.type.indexOf("zip") > 0){
                        fileImgSrc = fileImgSrc + "zip.png";
                    }else if(file.type.indexOf("text") > 0){
                        fileImgSrc = fileImgSrc + "txt.png";
                    }else{
                        fileImgSrc = fileImgSrc + "file.png";
                    }


                    // 图片上传的是图片还是其他类型文件
                    if (file.type.indexOf("image") == 0) {
                        html += '<div id="uploadList_'+ file.index +'" class="upload_append_list">';
                        html += '	<div class="file_bar">';
                        html += '		<div style="padding:5px;">';
                        html += '			<p class="file_name">' + file.name + '</p>';
                        html += delHtml;   // 删除按钮的html
                        html += '		</div>';
                        html += '	</div>';
                        html += '	<a style="height:'+para.itemHeight+';width:'+para.itemWidth+';" href="#" class="imgBox">';
                        html += '		<div class="uploadImg" style="width:'+imgWidth+'px">';
                        html += '			<img id="uploadImage_'+file.index+'" class="upload_image" src="' + e.target.result + '" style="width:expression(this.width > '+imgWidth+' ? '+imgWidth+'px : this.width)" />';
                        html += '		</div>';
                        html += '	</a>';
                        html += '	<p id="uploadProgress_'+file.index+'" class="file_progress"></p>';
                        html += '	<p id="uploadFailure_'+file.index+'" class="file_failure">上传失败，请重试</p>';
                        html += '	<p id="uploadSuccess_'+file.index+'" class="file_success"></p>';
                        html += '</div>';

                    }else{
                        html += '<div id="uploadList_'+ file.index +'" class="upload_append_list">';
                        html += '	<div class="file_bar">';
                        html += '		<div style="padding:5px;">';
                        html += '			<p class="file_name">' + file.name + '</p>';
                        html += delHtml;   // 删除按钮的html
                        html += '		</div>';
                        html += '	</div>';
                        html += '	<a style="height:'+para.itemHeight+';width:'+para.itemWidth+';" href="#" class="imgBox">';
                        html += '		<div class="uploadImg" style="width:'+imgWidth+'px">';
                        html += '			<img id="uploadImage_'+file.index+'" class="upload_image" src="' + fileImgSrc + '" style="width:expression(this.width > '+imgWidth+' ? '+imgWidth+'px : this.width)" />';
                        html += '		</div>';
                        html += '	</a>';
                        html += '	<p id="uploadProgress_'+file.index+'" class="file_progress"></p>';
                        html += '	<p id="uploadFailure_'+file.index+'" class="file_failure">上传失败，请重试</p>';
                        html += '	<p id="uploadSuccess_'+file.index+'" class="file_success"></p>';
                        html += '</div>';
                    }

                    return html;
                };

                /**
                 * 功能：调用核心插件
                 * 参数: 无
                 * 返回: 无
                 */
                this.createCorePlug = function(){
                    var params = {
                        fileInput: $("#fileImage").get(0),
                        uploadInput: $("#fileSubmit").get(0),
                        dragDrop: $("#fileDragArea").get(0),
                        url: $("#uploadForm").attr("action"),

                        filterFile: function(files) {
                            // 过滤合格的文件
                            return self.funFilterEligibleFile(files);
                        },
                        onSelect: function(selectFiles, allFiles) {
                            para.onSelect(selectFiles, allFiles);  // 回调方法
                            self.funSetStatusInfo(ZYFILE.funReturnNeedFiles());  // 显示统计信息
                            var html = '', i = 0;
                            // 组织预览html
                            var funDealtPreviewHtml = function() {
                                file = selectFiles[i];
                                if (file) {
                                    var reader = new FileReader()
                                    reader.onload = function(e) {
                                        // 处理下配置参数和格式的html
                                        html += self.funDisposePreviewHtml(file, e);

                                        i++;
                                        // 再接着调用此方法递归组成可以预览的html
                                        funDealtPreviewHtml();
                                    }
                                    reader.readAsDataURL(file);
                                } else {
                                    // 走到这里说明文件html已经组织完毕，要把html添加到预览区
                                    funAppendPreviewHtml(html);
                                }
                            };

                            // 添加预览html
                            var funAppendPreviewHtml = function(html){
                                // 添加到添加按钮前
                                if(para.dragDrop){
                                    $("#preview").append(html);
                                }else{
                                    $(".add_upload").before(html);
                                }
                                // 绑定删除按钮
                                funBindDelEvent();
                                funBindHoverEvent();
                            };

                            // 绑定删除按钮事件
                            var funBindDelEvent = function(){

                                if($(".file_del").length>0){
                                    // 删除方法
                                    $(".file_del").click(function() {
                                        ZYFILE.funDeleteFile(parseInt($(this).attr("data-index")), true);

                                        $("#uploadList_"+$(this).attr("data-index")).remove();
                                        if($(".file_del").length<4)
                                            $(".filePicker").css("visibility","visible");

                                        return false;
                                    });
                                }


                                if($(".file_edit").length>0){
                                    // 编辑方法
                                    $(".file_edit").click(function() {
                                        // 调用编辑操作
                                        //ZYFILE.funEditFile(parseInt($(this).attr("data-index")), true);
                                        return false;
                                    });
                                }
                            };

                            // 绑定显示操作栏事件
                            var funBindHoverEvent = function(){
                                $(".upload_append_list").hover(
                                    function (e) {
                                        $(this).find(".file_bar").addClass("file_hover");
                                    },function (e) {
                                        $(this).find(".file_bar").removeClass("file_hover");
                                    }
                                );
                            };

                            funDealtPreviewHtml();
                        },
                        onDelete: function(file, files) {
                            // 移除效果
                            $("#uploadList_" + file.index).fadeOut();
                            // 重新设置统计栏信息
                            self.funSetStatusInfo(files);
                        },
                        onProgress: function(file, loaded, total) {
                            var eleProgress = $("#uploadProgress_" + file.index), percent = (loaded / total * 100).toFixed(2) + '%';
                            if(eleProgress.is(":hidden")){
                                eleProgress.show();
                            }
                            eleProgress.css("width",percent);
                        },
                        onSuccess: function(file, response) {

                            if($("#demo").attr("pic")=="")
                                $("#demo").attr("pic",JSON.parse(response).name)
                            else
                                $("#demo").attr("pic",$("#demo").attr("pic")+','+JSON.parse(response).name)

                            $("#uploadProgress_" + file.index).hide();
                            $("#uploadSuccess_" + file.index).show();

                            // 根据配置参数确定隐不隐藏上传成功的文件
                            if(para.finishDel){
                                // 移除效果
                                $("#uploadList_" + file.index).fadeOut();
                                // 重新设置统计栏信息
                                self.funSetStatusInfo(ZYFILE.funReturnNeedFiles());
                            }
                        },
                        onFailure: function(file) {
                            $("#uploadProgress_" + file.index).hide();
                            $("#uploadSuccess_" + file.index).show();
                            $("#uploadInf").append("<p>文件" + file.name + "上传失败！</p>");
                            //$("#uploadImage_" + file.index).css("opacity", 0.2);
                        },
                        onComplete: function(response){
                        },
                        onDragOver: function() {
                            $(this).addClass("upload_drag_hover");
                        },
                        onDragLeave: function() {
                            $(this).removeClass("upload_drag_hover");
                        }

                    };

                    ZYFILE = $.extend(ZYFILE, params);
                    ZYFILE.init();
                };

                /**
                 * 功能：绑定事件
                 * 参数: 无
                 * 返回: 无
                 */
                this.addEvent = function(){
                    // 如果快捷添加文件按钮存在
                    if($(".filePicker").length > 0){
                        // 绑定选择事件
                        $(".filePicker").bind("click", function(e){
                            $("#fileImage").click();
                            if($(".file_del").length==3)
                                $(".filePicker").css("visibility","hidden");
                        });
                    }

                    // 绑定继续添加点击事件
                    $(".webuploader_pick").bind("click", function(e){
                        $("#fileImage").click();
                    });

                    // 绑定上传点击事件
                    $(".upload_btn").bind("click", function(e){
                        // 判断当前是否有文件需要上传
                        if(ZYFILE.funReturnNeedFiles().length > 0){
                            $("#fileSubmit").click();
                        }else{
                            alert("请先选中文件再点击上传");
                        }
                    });

                    // 如果快捷添加文件按钮存在
                    if($("#rapidAddImg").length > 0){
                        // 绑定添加点击事件
                        $("#rapidAddImg").bind("click", function(e){
                            $("#fileImage").click();
                        });
                    }
                };


                // 初始化上传控制层插件
                this.init();
            });
        };
        var ZYFILE = {
            fileInput : null,             // 选择文件按钮dom对象
            uploadInput : null,           // 上传文件按钮dom对象
            dragDrop: null,				  //拖拽敏感区域
            url : "",  					  // 上传action路径
            uploadFile : [],  			  // 需要上传的文件数组
            lastUploadFile : [],          // 上一次选择的文件数组，方便继续上传使用
            perUploadFile : [],           // 存放永久的文件数组，方便删除使用
            fileNum : 0,                  // 代表文件总个数，因为涉及到继续添加，所以下一次添加需要在它的基础上添加索引
            /* 提供给外部的接口 */
            filterFile : function(files){ // 提供给外部的过滤文件格式等的接口，外部需要把过滤后的文件返回
                return files;
            },
            onSelect : function(selectFile, files){      // 提供给外部获取选中的文件，供外部实现预览等功能  selectFile:当前选中的文件  allFiles:还没上传的全部文件

            },
            onDelete : function(file, files){            // 提供给外部获取删除的单个文件，供外部实现删除效果  file:当前删除的文件  files:删除之后的文件

            },
            onProgress : function(file, loaded, total){  // 提供给外部获取单个文件的上传进度，供外部实现上传进度效果

            },
            onSuccess : function(file, responseInfo){    // 提供给外部获取单个文件上传成功，供外部实现成功效果

            },
            onFailure : function(file, responseInfo){    // 提供给外部获取单个文件上传失败，供外部实现失败效果

            },
            onComplete : function(responseInfo){         // 提供给外部获取全部文件上传完成，供外部实现完成效果

            },

            /* 内部实现功能方法 */
            // 获得选中的文件
            //文件拖放
            funDragHover: function(e) {
                e.stopPropagation();
                e.preventDefault();
                this[e.type === "dragover"? "onDragOver": "onDragLeave"].call(e.target);
                return this;
            },
            // 获取文件
            funGetFiles : function(e){
                var self = this;
                // 取消鼠标经过样式
                this.funDragHover(e);
                // 从事件中获取选中的所有文件
                var files = e.target.files || e.dataTransfer.files;
                self.lastUploadFile = this.uploadFile;
                this.uploadFile = this.uploadFile.concat(this.filterFile(files));
                var tmpFiles = [];

                // 因为jquery的inArray方法无法对object数组进行判断是否存在于，所以只能提取名称进行判断
                var lArr = [];  // 之前文件的名称数组
                var uArr = [];  // 现在文件的名称数组
                $.each(self.lastUploadFile, function(k, v){
                    lArr.push(v.name);
                });
                $.each(self.uploadFile, function(k, v){
                    uArr.push(v.name);
                });

                $.each(uArr, function(k, v){
                    // 获得当前选择的每一个文件   判断当前这一个文件是否存在于之前的文件当中
                    if($.inArray(v, lArr) < 0){  // 不存在
                        tmpFiles.push(self.uploadFile[k]);
                    }
                });

                // 如果tmpFiles进行过过滤上一次选择的文件的操作，需要把过滤后的文件赋值
                //if(tmpFiles.length!=0){
                this.uploadFile = tmpFiles;
                //}

                // 调用对文件处理的方法
                this.funDealtFiles();

                return true;
            },
            // 处理过滤后的文件，给每个文件设置下标
            funDealtFiles : function(){
                var self = this;
                // 目前是遍历所有的文件，给每个文件增加唯一索引值
                $.each(this.uploadFile, function(k, v){
                    // 因为涉及到继续添加，所以下一次添加需要在总个数的基础上添加
                    v.index = self.fileNum;
                    // 添加一个之后自增
                    self.fileNum++;
                });
                // 先把当前选中的文件保存备份
                var selectFile = this.uploadFile;
                // 要把全部的文件都保存下来，因为删除所使用的下标是全局的变量
                this.perUploadFile = this.perUploadFile.concat(this.uploadFile);
                // 合并下上传的文件
                this.uploadFile = this.lastUploadFile.concat(this.uploadFile);

                // 执行选择回调
                this.onSelect(selectFile, this.uploadFile);

                return this;
            },
            // 处理需要删除的文件  isCb代表是否回调onDelete方法
            // 因为上传完成并不希望在页面上删除div，但是单独点击删除的时候需要删除div   所以用isCb做判断
            funDeleteFile : function(delFileIndex, isCb){
                var self = this;  // 在each中this指向没个v  所以先将this保留
                var tmpFile = [];  // 用来替换的文件数组
                // 合并下上传的文件
                var delFile = this.perUploadFile[delFileIndex];

                // 目前是遍历所有的文件，对比每个文件  删除
                $.each(this.uploadFile, function(k, v){
                    if(delFile != v){
                        // 如果不是删除的那个文件 就放到临时数组中
                        tmpFile.push(v);
                    }else{

                    }
                });
                this.uploadFile = tmpFile;
                if(isCb){  // 执行回调
                    // 回调删除方法，供外部进行删除效果的实现
                    self.onDelete(delFile, this.uploadFile);
                }

                return true;
            },
            // 上传多个文件
            funUploadFiles : function(){
                var self = this;  // 在each中this指向没个v  所以先将this保留
                // 遍历所有文件  ，在调用单个文件上传的方法
                $.each(this.uploadFile, function(k, v){
                    self.funUploadFile(v);
                });
            },
            // 上传单个个文件
            funUploadFile : function(file){
                var self = this;  // 在each中this指向没个v  所以先将this保留

                var formdata = new FormData();
                formdata.append("file", file);
                var xhr = new XMLHttpRequest();
                // 绑定上传事件
                // 进度
                xhr.upload.addEventListener("progress",	 function(e){
                    // 回调到外部
                    self.onProgress(file, e.loaded, e.total);
                }, false);
                // 完成
                xhr.addEventListener("load", function(e){
                    // 从文件中删除上传成功的文件  false是不执行onDelete回调方法
                    self.funDeleteFile(file.index, false);
                    // 回调到外部
                    self.onSuccess(file, xhr.responseText);
                    if(self.uploadFile.length==0){
                        // 回调全部完成方法
                        self.onComplete("全部完成");
                    }
                }, false);
                // 错误
                xhr.addEventListener("error", function(e){
                    // 回调到外部
                    self.onFailure(file, xhr.responseText);
                }, false);

                xhr.open("POST",self.url, true);
                xhr.setRequestHeader("X_FILENAME", file.name);
                xhr.send(formdata);
            },
            // 返回需要上传的文件
            funReturnNeedFiles : function(){
                return this.uploadFile;
            },

            // 初始化
            init : function(){  // 初始化方法，在此给选择、上传按钮绑定事件
                var self = this;  // 克隆一个自身

                if (this.dragDrop) {
                    this.dragDrop.addEventListener("dragover", function(e) { self.funDragHover(e); }, false);
                    this.dragDrop.addEventListener("dragleave", function(e) { self.funDragHover(e); }, false);
                    this.dragDrop.addEventListener("drop", function(e) { self.funGetFiles(e); }, false);
                }

                // 如果选择按钮存在
                if(self.fileInput){
                    // 绑定change事件
                    this.fileInput.addEventListener("change", function(e) {
                        self.funGetFiles(e);
                    }, false);
                }

                // 如果上传按钮存在
                if(self.uploadInput){
                    // 绑定click事件
                    this.uploadInput.addEventListener("click", function(e) {
                        self.funUploadFiles(e);
                    }, false);
                }
            }
        };

        var form = layui.form,
            layer = layui.layer,
            layarea = layui.layarea;
        //提交的地址信息
        var address = "",
            estateId = "";

        /*省市区三级选择器*/
        layarea.render({
            elem: '#area-picker',
            change: function (res) {
                address = res.province+res.city+res.county
            }
        });

        /**
         * 初始化表单，要加上，不然刷新部分组件可能会不加载
         */
        form.render();

        //自定义验证规则
        form.verify({
            title: function (value) {
                if (value.length < 5) {
                    return '标题至少得5个字符啊';
                }
            },
            addrDetail:function(value){
                if(value.length == 0){
                    return "必须填写详细地址";
                }
                address += value;
            },
            ZH:[
                /^[\u4e00-\u9fa5]{2,4}$/,
                '请输入中文姓名，超过4个字请简写'
            ]
        });
        // 图片上传插件
        $("#demo").zyUpload({
            itemWidth        :   "120px",                 // 文件项的宽度
            itemHeight       :   "100px",                 // 文件项的高度
            url              :   "http://localhost:9091/pic/upload",  // 上传文件的路径
            multiple         :   false,                    // 是否可以多个文件上传
            dragDrop         :   true,                    // 是否可以拖动上传文件
            del              :   true,                    // 是否可以删除文件
            finishDel        :   false,  				  // 是否在上传文件完成后删除预览
        });

        //监听提交
        form.on('submit(demo1)', function (data) {
            var values = data.field
            console.log(data)
            var payload = {}

            //数据处理
            estateId = Base64.encode64(Base64.utf16to8(address))
            if(values.floor_1 && values.floor_2){
                values.floor = values.floor_1  + "/" + values.floor_2;
            }
            values.houseType = values.houseType_1  +"室"+ values.houseType_2  +"厅"+
                values.houseType_3 +"卫"+ values.houseType_4+"厨"+values.houseType_5+"阳台";
            values.facilities = ""
            for(let i = 1;i <= 9;++i){
                if(values["facilities_"+i]=="on"){
                    if(values.facilities=="")
                        values.facilities += i
                    else
                        values.facilities = values.facilities + "," + i;
                }
            }

            payload.id = new Date().getTime();
            payload.title = values.title;
            payload.estateId = estateId;
            payload.buildingNum = values.buildingNum;
            payload.buildingUnit = values.buildingUnit;
            payload.buildingFloorNum = values.buildingFloorNum;
            payload.floor = values.floor;
            payload.houseType = values.houseType;
            payload.coveredArea = values.coveredArea;
            payload.useArea = values.useArea;
            payload.orientation = values.orientation;
            payload.decoration = values.decoration;
            payload.facilities = values.facilities;
            payload.houseDesc = values.desc;
            payload.rent = values.rent;
            payload.paymentMethod = values.payment_method;
            payload.rentMethod = values.rent_method;
            payload.contact = values.contact;
            payload.mobile = values.mobile;
            payload.time = values.time;
            payload.propertyCost = values.propertyCost;
            payload.pic = $("#demo").attr("pic")

            console.log(payload)
            //查询经纬度
            $.ajax({
                url:"http://api.map.baidu.com/geocoding/v3/?address="+address
                +"&output=json&ak=q60ejYQeO2qZO6dYhWPOHea4aY0bhrqG&callback=showLocation",
                dataType:"jsonp",
                success:function(res){
                    if(res.status==0){
                        //查询成功
                        payload.lng = res.result.location.lng;//经度
                        payload.lat = res.result.location.lat;//纬度
                        $.post({
                            url:"http://localhost:9091/bg/house/resources",
                            contentType:'application/json',
                            data:JSON.stringify(payload),
                            success:function(res){
                                //墨绿深蓝风
                                layer.alert('提交成功', {
                                    skin: 'layui-layer-lan',
                                    closeBtn: 0
                                }, function(){
                                    layer.closeAll();
                                    window.location.reload();
                                });
                            },
                            error:function(err){
                                console.log(err)
                                layer.alert('提交失败', {
                                    skin: 'layui-layer-lan',
                                    closeBtn: 0
                                }, function(){
                                    layer.closeAll();
                                    window.location.reload()
                                });
                            }
                        })
                    }
                }
            });

            return false;
        });
    });


</script>