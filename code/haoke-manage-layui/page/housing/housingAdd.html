<!-- 引用控制层插件样式 -->
<link rel="stylesheet" href="lib/jq-module/zyupload/control/css/zyUpload.css" type="text/css">
<!-- 引用核心层插件 -->
<script type="text/javascript" src="lib/jq-module/zyupload/core/zyFile.js"></script>
<!-- 引用控制层插件 -->
<script type="text/javascript" src="lib/jq-module/zyupload/control/js/zyUpload.js"></script>

<script type="text/javascript" src="lib/jquery-3.4.1/jquery-3.4.1.min.js"></script>


<script src="lib/mods/base64.js"></script>

<div class="layuimini-container layuimini-page-anim">
    <div class="layuimini-main">
        <form class="layui-form layui-form-pane" id="addHousing" action="">
            <!--房源信息-->
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend>房源信息</legend>
            </fieldset>
            <!--标题-->
            <div class="layui-form-item">
                <label class="layui-form-label">房源标题</label>
                <div class="layui-input-block">
                    <input type="text" name="title" lay-verify="title" autocomplete="off" placeholder="请输入标题"
                           class="layui-input">
                </div>
            </div>
            <!--地址-->
            <div class="layui-form-item" id="area-picker">
                <div class="layui-form-label">地址</div>
                <div class="layui-input-inline" style="width: 200px;">
                    <select name="province" lay-search="" class="province-selector" data-value="选择省" lay-verify="required" lay-filter="province-1">
                        <option value="">请选择省</option>
                    </select>
                </div>
                <div class="layui-input-inline" style="width: 200px;">
                    <select name="city" lay-search="" class="city-selector" data-value="选择市" lay-verify="required" lay-filter="city-1">
                        <option value="">请选择市</option>
                    </select>
                </div>
                <div class="layui-input-inline" style="width: 200px;">
                    <select name="county" lay-search="" class="county-selector" data-value="选择区" lay-verify="required" lay-filter="county-1">
                        <option value="">请选择区</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">详细地址</label>
                <div class="layui-input-block">
                    <input class="layui-input" id="addrDetail"  autocomplete="on" lay-verify="addrDetail"
                           placeholder="街道+小区名">
                </div>
            </div>
            <!--楼栋-->
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">楼栋</label>
                    <div class="layui-input-inline">
                        <input type="text" name="buildingNum"  lay-verify="required|number" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid">栋</div>
                    <div class="layui-input-inline">
                        <input type="text" name="buildingUnit"  lay-verify="required|number" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid">单元</div>
                    <div class="layui-input-inline">
                        <input type="text" name="buildingFloorNum"  lay-verify="required|number" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid">门牌号</div>
                </div>
            </div>
            <!--楼层-->
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">所处楼层</label>
                    <div class="layui-input-inline">
                        <input type="text" name="floor_1"  lay-verify="required|number" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid ">层</div>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">总楼层</label>
                <div class="layui-inline">
                    <div class="layui-input-inline">
                        <input type="text" name="floor_2"  lay-verify="required|number" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid">层</div>
                </div>
            </div>
            <!--户型-->
            <div class="layui-form-item layui-inline">
                <label class="layui-form-label">户型</label>
                <div class="layui-input-inline">
                    <input type="text" name="houseType_1"  lay-verify="required|number" autocomplete="off" class="layui-input">
                </div>
                <div class="layui-form-mid">室</div>
                <div class="layui-input-inline">
                    <input type="text" name="houseType_2"  lay-verify="required|number" autocomplete="off" class="layui-input">
                </div>
                <div class="layui-form-mid">厅&nbsp;&nbsp;&nbsp;&nbsp;</div>
                <div class="layui-input-inline">
                    <input type="text" name="houseType_3"  lay-verify="required|number" autocomplete="off" class="layui-input">
                </div>
                <div class="layui-form-mid">卫</div>
                <div class="layui-input-inline">
                    <input type="text" name="houseType_4"  lay-verify="required|number" autocomplete="off" class="layui-input">
                </div>
                <div class="layui-form-mid">厨</div>
                <div class="layui-input-inline">
                    <input type="text" name="houseType_5"  lay-verify="required|number" autocomplete="off" class="layui-input">
                </div>
                <div class="layui-form-mid">阳台</div>
            </div>
            <!--面积-->
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">建筑面积</label>
                    <div class="layui-input-inline">
                        <input type="text" name="coveredArea" lay-verify="required|number" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid">平方米</div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">使用面积</label>
                    <div class="layui-input-inline">
                        <input type="text" name="useArea" lay-verify="required|number" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid">平方米</div>
                </div>
            </div>
            <!--朝向-->
            <div class="layui-form-item layui-inline">
                <label class="layui-form-label">朝向</label>
                <div class="layui-input-inline">
                    <select name="orientation" lay-verify="required">
                        <option value="">请选择朝向</option>
                        <option value="1">南</option>
                        <option value="2">东</option>
                        <option value="3">北</option>
                        <option value="4">西</option>
                    </select>
                </div>
            </div>
            <!--装修-->
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">装修</label>
                    <div class="layui-input-inline">
                        <select name="decoration" lay-verify="required">
                            <option value="">请选择装修类型</option>
                            <option value="1">精装</option>
                            <option value="2">简装</option>
                            <option value="3">毛坯</option>
                        </select>
                    </div>
                </div>
            </div>
            <!--配套设施-->
            <div class="layui-form-item" pane="">
                <label class="layui-form-label">配套设施</label>
                <div class="layui-input-block">
                    <input type="checkbox" name="facilities_1" lay-skin="primary" title="水" checked="">
                    <input type="checkbox" name="facilities_2" lay-skin="primary" title="电" checked>
                    <input type="checkbox" name="facilities_3" lay-skin="primary" title="煤气/天然气" checked>
                    <input type="checkbox" name="facilities_4" lay-skin="primary" title="暖气/地暖">
                    <input type="checkbox" name="facilities_5" lay-skin="primary" title="有线电视">
                    <input type="checkbox" name="facilities_6" lay-skin="primary" title="宽带">
                    <input type="checkbox" name="facilities_7" lay-skin="primary" title="电梯">
                    <input type="checkbox" name="facilities_8" lay-skin="primary" title="车位/车库">
                    <input type="checkbox" name="facilities_9" lay-skin="primary" title="地下室/储藏室">
                </div>
            </div>

            <!--图片信息-->
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px;">
                <legend>图片信息</legend>
            </fieldset>
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">最多上传四张图片</label>
                <div name="pic" class="layui-input-block">
                    <div id="demo" class="demo layui-textarea" pic=""></div>
                </div>
            </div>
            <!--房源描述-->
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">房源描述</label>
                <div class="layui-input-block">
                    <textarea name="desc" placeholder="请勿填写联系方式或与房源信息以及图片、链接或品牌、优秀、顶级、全网首发、零距离、回报率等词汇。" class="layui-textarea"></textarea>
                </div>
            </div>

            <!--租赁信息-->
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px;">
                <legend>租赁信息</legend>
            </fieldset>
            <div class="layui-form-item">
                <!--联系人-->
                <div class="layui-form-item layui-inline">
                    <label class="layui-form-label">联系人</label>
                    <div class="layui-input-block">
                        <input type="text" autocomplete name="contact" lay-verify="ZH" placeholder="请输入联系人" class="layui-input">
                    </div>
                </div>
                <!--联系方式-->
                <div class="layui-form-item layui-inline">
                    <div class="layui-inline">
                        <label class="layui-form-label">联系方式</label>
                        <div class="layui-input-inline">
                            <input type="tel" autocomplete="on" placeholder="请输入联系方式" name="mobile" lay-verify="required|phone" class="layui-input">
                        </div>
                    </div>
                </div>
            </div>
            <!--租赁方式-->
            <div class="layui-form-item layui-inline">
                <label class="layui-form-label">租赁方式</label>
                <div class="layui-input-inline">
                    <select name="rent_method" lay-verify="required">
                        <option value="">请选择租赁方式</option>
                        <option value="1">整租</option>
                        <option value="2">合租</option>
                    </select>
                </div>
            </div>
            <!--支付方式-->
            <div class="layui-form-item layui-inline">
                <label class="layui-form-label">支付方式</label>
                <div class="layui-input-inline">
                    <select name="payment_method" lay-verify="required">
                        <option value="">请选择支付方式</option>
                        <option value="1">付一押一</option>
                        <option value="2">付三押一</option>
                        <option value="3">付六押一</option>
                        <option value="4">年付押一</option>
                        <option value="5">其它</option>
                    </select>
                </div>
            </div>
            <!--看房时间-->
            <div class="layui-form-item layui-inline">
                <label class="layui-form-label">看房时间</label>
                <div class="layui-input-inline">
                    <select name="time" lay-verify="required">
                        <option value="">请选择看房时间</option>
                        <option value="1">上午</option>
                        <option value="2">中午</option>
                        <option value="3">下午</option>
                        <option value="4">晚上</option>
                        <option value="5">全天</option>
                    </select>
                </div>
            </div>
            <!--租金-->
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">租金</label>
                    <div class="layui-input-inline">
                        <input type="text" name="rent" lay-verify="required|number" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid">元/月</div>
                </div>
            </div>
            <!--物业费-->
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">物业费</label>
                    <div class="layui-input-inline">
                        <input type="text" name="propertyCost" lay-verify="required|number" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid">元/平</div>
                </div>
            </div>

            <!--提交-->
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit="" lay-filter="demo1">立即提交</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!--表单基本组件-->
<script>
    layui.config({
        base: 'lib/mods/'
    });
    layui.use(['form','layarea'], function () {

        //加载组件
        var $ = layui.jquery,
            form = layui.form,
            layer = layui.layer,
            layarea = layui.layarea;
        //提交的地址信息
        var address = "",
            estateId = "";

        /*省市区三级选择器*/
        layarea.render({
            elem: '#area-picker',
            change: function (res) {
                address = res.province+res.city+res.county
            }
        });

        /**
         * 初始化表单，要加上，不然刷新部分组件可能会不加载
         */
        form.render();

        //自定义验证规则
        form.verify({
            title: function (value) {
                if (value.length < 5) {
                    return '标题至少得5个字符啊';
                }
            },
            addrDetail:function(value){
                if(value.length == 0){
                    return "必须填写详细地址";
                }
                address += value;
            },
            ZH:[
                /^[\u4e00-\u9fa5]{2,4}$/,
                '请输入中文姓名，超过4个字请简写'
            ]
        });
        // 图片上传插件
        $("#demo").zyUpload({
            itemWidth        :   "120px",                 // 文件项的宽度
            itemHeight       :   "100px",                 // 文件项的高度
            url              :   "http://localhost:9091/pic/upload",  // 上传文件的路径
            multiple         :   false,                    // 是否可以多个文件上传
            dragDrop         :   true,                    // 是否可以拖动上传文件
            del              :   true,                    // 是否可以删除文件
            finishDel        :   false,  				  // 是否在上传文件完成后删除预览
        });

        //监听提交
        form.on('submit(demo1)', function (data) {
            var values = data.field
            console.log(data)
            var payload = {}

            //数据处理
            estateId = Base64.encode64(Base64.utf16to8(address))
            if(values.floor_1 && values.floor_2){
                values.floor = values.floor_1  + "/" + values.floor_2;
            }
            values.houseType = values.houseType_1  +"室"+ values.houseType_2  +"厅"+
                values.houseType_3 +"卫"+ values.houseType_4+"厨"+values.houseType_5+"阳台";
            values.facilities = ""
            for(let i = 1;i <= 9;++i){
                if(values["facilities_"+i]=="on"){
                    if(values.facilities=="")
                        values.facilities += i
                    else
                        values.facilities = values.facilities + "," + i;
                }
            }

            payload.title = values.title;
            payload.estateId = estateId;
            payload.buildingNum = values.buildingNum;
            payload.buildingUnit = values.buildingUnit;
            payload.buildingFloorNum = values.buildingFloorNum;
            payload.floor = values.floor;
            payload.houseType = values.houseType;
            payload.coveredArea = values.coveredArea;
            payload.useArea = values.useArea;
            payload.orientation = values.orientation;
            payload.decoration = values.decoration;
            payload.facilities = values.facilities;
            payload.houseDesc = values.desc;
            payload.rent = values.rent;
            payload.paymentMethod = values.payment_method;
            payload.rentMethod = values.rent_method;
            payload.contact = values.contact;
            payload.mobile = values.mobile;
            payload.time = values.time;
            payload.propertyCost = values.propertyCost;
            payload.pic = $("#demo").attr("pic")

            console.log(payload)
            //查询经纬度
            $.ajax({
                url:"http://api.map.baidu.com/geocoding/v3/?address="+address
                +"&output=json&ak=q60ejYQeO2qZO6dYhWPOHea4aY0bhrqG&callback=showLocation",
                dataType:"jsonp",
                success:function(res){
                    if(res.status==0){
                        //查询成功
                        payload.lng = res.result.location.lng;//经度
                        payload.lat = res.result.location.lat;//纬度
                        $.post({
                            url:"http://localhost:9091/bg/house/resources",
                            contentType:'application/json',
                            data:JSON.stringify(payload),
                            success:function(res){
                                //墨绿深蓝风
                                layer.alert('提交成功', {
                                    skin: 'layui-layer-lan',
                                    closeBtn: 0
                                }, function(){
                                    layer.closeAll();
                                    window.location.reload();
                                });
                            },
                            error:function(err){
                                console.log(err)
                                layer.alert('提交失败', {
                                    skin: 'layui-layer-lan',
                                    closeBtn: 0
                                }, function(){
                                    layer.closeAll();
                                    window.location.reload()
                                });
                            }
                        })
                    }
                }
            });

            return false;
        });
    });


</script>